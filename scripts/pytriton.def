# Copyright (c) 2023, NVIDIA CORPORATION. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
Bootstrap: docker
From: nvcr.io/nvidia/tritonserver:23.04-pyt-python-py3



%environment
export WORKDIR=/opt/workspace
export PYENV_ROOT=/root/.pyenv
export PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH
export PYTHON_VERSIONS="3.8,3.9,3.10,3.11,3.12"
export PYTHON_VERSIONS=$PYTHON_VERSIONS
export MAKEFLAGS=""

%files
 scripts/build_python_stubs.sh /opt/workspace/build_python_stubs.sh


# Latest cmake installation - https://apt.kitware.com
%post
    apt-get update -y \
    && apt-get install ca-certificates gpg wget \
    && test -f /usr/share/doc/kitware-archive-keyring/copyright || wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null \
    && echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/kitware.list >/dev/null \
    && apt-get update -y \
    && test -f /usr/share/doc/kitware-archive-keyring/copyright || rm /usr/share/keyrings/kitware-archive-keyring.gpg \
    && apt-get install -y kitware-archive-keyring \
    && apt update -y && apt install -y build-essential \
  cmake \
  make \
  rapidjson-dev \
  libarchive-dev \
  zlib1g-dev \
  libssl-dev \
  libsqlite3-dev \
  libbz2-dev \
  liblzma-dev \
  libffi-dev \
  libreadline-dev \
  && curl https://pyenv.run | bash \
  && export PYENV_ROOT="$HOME/.pyenv" \
  && [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"\
  && eval "$(pyenv init -)" \
  && cd /opt/workspace \
  && bash -xe /opt/workspace/build_python_stubs.sh

%runscript
 bash -xe /opt/workspace/build_python_stubs.sh
